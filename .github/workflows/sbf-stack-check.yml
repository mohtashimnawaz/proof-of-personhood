name: SBF stack regression check

on:
  pull_request:
  push:
    branches: [ main, 'ci/**', 'sbf/**' ]

jobs:
  sbf-stack-check:
    name: SBF Stack Regression Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: Install Node.js (for Anchor if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Solana CLI
        run: |
          curl -sSfL https://release.solana.com/stable/install | sh
          echo "${HOME}/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          set -euo pipefail
          # Prefer cargo-installed anchor from a known tag; fallback to npm (with perms fix)
          export PATH="$HOME/.cargo/bin:$PATH"
          if ! command -v anchor >/dev/null 2>&1; then
            cargo install --git https://github.com/coral-xyz/anchor anchor --tag v0.31.1 --locked --bin anchor || \
            (npm i -g --unsafe-perm @coral-xyz/anchor-cli@0.31.1 && chmod +x "$(command -v anchor)") || true
          fi
          # Ensure cargo bin directory is available in subsequent steps
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          ANCHOR_BIN="$(command -v anchor || true)"
          echo "anchor binary: $ANCHOR_BIN"
          # Attempt to print version; if it fails (EACCES) try chmod underlying path and retry,
          # otherwise attempt to force-install cargo-built anchor (try without --locked first).
          if ! "$ANCHOR_BIN" --version 2>&1 | tee anchor_version.txt ; then
            BINPATH=$(sed -nE 's/.*spawnSync ([^ ]+) EACCES.*/\1/p' anchor_version.txt | head -n1 || true)
            if [ -n "$BINPATH" ]; then
              chmod +x "$BINPATH" || true
              "$ANCHOR_BIN" --version 2>&1 | tee -a anchor_version.txt || true
            else
              chmod +x "$ANCHOR_BIN" || true
              "$ANCHOR_BIN" --version 2>&1 | tee -a anchor_version.txt || true
            fi
            if ! grep -E "anchor-cli (0\.(31|32)\.)" anchor_version.txt >/dev/null 2>&1; then
              cargo install --git https://github.com/coral-xyz/anchor anchor --tag v0.31.1 --bin anchor || \
              cargo install --git https://github.com/coral-xyz/anchor anchor --tag v0.31.1 --locked --bin anchor || true
              echo "$HOME/.cargo/bin" >> $GITHUB_PATH
              ANCHOR_BIN="$(command -v anchor || true)"
              "$ANCHOR_BIN" --version 2>&1 | tee -a anchor_version.txt || true
            fi
          fi
          grep -E "anchor-cli (0\.(31|32)\.)" anchor_version.txt || anchor --version || true
          rm -f anchor_version.txt

      - name: Run anchor build and check SBF stack usage
        env:
          RUSTFLAGS: "-C target-cpu=native"
        run: |
          set -o pipefail
          anchor build 2>&1 | tee build.log || true
          if grep -E "Stack offset of [0-9]+ exceeded max offset of 4096" build.log; then
            echo "SBF stack regression detected:" >&2
            grep -nE "Stack offset of [0-9]+ exceeded max offset of 4096" build.log >&2
            exit 1
          fi

      - name: (Optional) Run Anchor tests
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          # Run quick tests but keep failure of this step from being fatal to the stack check job
          set -o pipefail
          anchor test --skip-lint 2>&1 | tee test.log || true
          echo "Tests finished."
